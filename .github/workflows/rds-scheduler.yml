name: RDS Auto Start-Stop

on:
  schedule:
    # 09:00 SGT is 01:00 UTC
    - cron: "0 1 * * 1-5"
    # 18:00 SGT is 10:00 UTC
    - cron: "0 10 * * 1-5"
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform (START or STOP)"
        required: true
        default: "START"
        type: choice
        options:
          - START
          - STOP

jobs:
  rds-scheduler:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Determine Action
        id: get_action
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" == "01" ]; then
              echo "action=START" >> $GITHUB_OUTPUT
            else
              echo "action=STOP" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Execute RDS Action
        run: |
          ACTION=${{ steps.get_action.outputs.action }}
          INSTANCE_ID=${{ secrets.RDS_INSTANCE_ID }}

          echo "Performing $ACTION on $INSTANCE_ID"

          if [ "$ACTION" == "START" ]; then
            aws rds start-db-instance --db-instance-identifier $INSTANCE_ID
          elif [ "$ACTION" == "STOP" ]; then
            aws rds stop-db-instance --db-instance-identifier $INSTANCE_ID
          fi
